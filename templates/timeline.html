{% extends 'includes/_base.html' %}
{% load i18n %}

{% block js %}
<script type="text/javascript">
var vlogs;

$(function() {
    $('.has_enddate').click(function() {
        $('.end_date').toggleClass('hidden');
    });

    $('form#new_log').submit(function() {
        return false;
    });

    $('#fake_reload').click(function() {
        $('#fake_loading').addClass('icon-spin');
        loadLogs();
    });

    $('#new_kind').click(function() {
        $(this).hide();
        $('.custom_select_container').hide();
        $('#nlog_kind_create').removeClass('hidden');
        $('#cancel_new_kind').removeClass('hidden');
    })

    $('#cancel_new_kind').click(function() {
        $(this).addClass('hidden');
        $('#new_kind').show();
        $('.custom_select_container').show();
        $('#nlog_kind_create').addClass('hidden');
        $('#cancel_new_kind').addClass('hidden');
    })

    $('#side_affix').affix({
        offset: {
            top: 85,
            bottom: function () {
                return (this.bottom = $('.footer').outerHeight(true))
            }
        }
    })

    var simplemde = new SimpleMDE({
        element: document.getElementById('nlog_body'),
        hideIcons: ["side-by-side", "italic", "heading"],
        spellChecker: false,
        status: false,
        tabSize: 4
    });
    loadLogs();

    $('#nlog_kind_icon').selectpicker({
        style: 'btn-xs',
        size: 6,
        width: 'fit'
    });

    $('#nlog_kind').selectpicker({
        style: 'btn-default custom_select',
        size: 6,
        width: '350px',
        liveSearch: true,
        showIcon: true
    });

})

function loadLogs() {
    $.getJSON('/api/v1/logs/', function(res) {
        vlogs.logs = res;
        $('#fake_loading').removeClass('icon-spin');
    });
}

function qs(el) {
    vlogs.q = $(el).html();
}
</script>
{% endblock %}

{% block content %}
<div class="col-md-8">
    <div class="timeline-centered" id="main_timeline">

        <article class="timeline-entry" v-if="!filteredLogs.length">
            <div class="timeline-entry-inner">

                <div class="timeline-icon bg-danger">
                    <span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span>
                </div>

                <div class="timeline-label">
                    {% blocktrans %}
                    <p>
                    <h3 style="margin: 3px">Oooops, nothing found!</h3>
                    Your search criteria didn't match anything, try using another keywords...
                    </p>
                    {% endblocktrans %}
                </div>
            </div>
        </article>

        <article class="timeline-entry" v-for="log in filteredLogs">
            <div class="timeline-entry-inner">

                <div class="timeline-icon" v-bind:class="{ 'bg-secondary': log.reminder }">
                    <span class="glyphicon" v-bind:class="'glyphicon-' + [[ log.kind.glyphicon_name ]]" aria-hidden="true"></span>
                </div>

                <div class="timeline-label">
                    <div class="log_date">[[ log.start_date ]]</div>
                    <p v-html="log.body_md"></p>

                    <div class="has_companies" v-show="log.companies || log.people">
                        <span class="label label-primary" onclick="qs(this);" v-for="company in log.companies">[[ company.name ]]</span>
                        <span class="label label-success" onclick="qs(this);" v-for="person in log.people">[[ person.name ]]</span>
                    </div>
                </div>
            </div>
        </article>

        <article class="timeline-entry" v-show="!logs.length">
            <div class="timeline-entry-inner">

                <div class="timeline-icon bg-danger">
                    <span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span>
                </div>

                <div class="timeline-label">
                    {% blocktrans %}
                    <p>
                    <h3 style="margin: 0">Ohhh no!</h3>
                    Nothing found... start creating your life log with the form on the right!
                    </p>
                    <p><div style="text-align: right; padding-top: 10px; padding-bottom: 0; color: #de2a4a;"><strong>Create things here >>></strong></div></p>
                    {% endblocktrans %}
                </div>
            </div>
        </article>

        <article class="timeline-entry begin">
            <div class="timeline-entry-inner">
                <div id="fake_reload" class="timeline-icon bg-black" style="background: #333;">
                    <span id="fake_loading" class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                </div>
            </div>
        </article>

    </div>
</div>
<div class="col-md-4">
    <div id="side_affix" class="affix">
        <h3>New log!</h3>
        <form id="new_log">
            <div class="form-group">
                <a id="new_kind" class="label label-warning new_kind pull-right">{% trans "+ new" %}</a>
                <a id="cancel_new_kind" class="label label-danger new_kind pull-right hidden">{% trans "cancel" %}</a>
                <label for="nlog_kind">{% trans "What?" %}</label>
                <div class="custom_select_container">
                <select class="form-control" id="nlog_kind" data-style="btn-danger">
                    {% for kind in kinds %}
                    <option data-icon="glyphicon-{{ kind.glyphicon_name }}">{{ kind.name }}</option>
                    {% endfor %}
                </select>
                </div>
                <div class="form-inline hidden" id="nlog_kind_create">
                    <div class="form-group new_kind_form">
                        <label for="nlog_kind_text">{% trans "Name:" %} </label>
                        <input type="text" class="form-control form-little" id="nlog_kind_text">
                        <label for="nlog_kind_icon">&nbsp;&nbsp;{% trans "Icon:" %} </label>
                        {# <input type="text" class="form-control form-little" id="nlog_kind_icon" placeholder="glyphicon class..." style="width: 110px !important;"><a href="http://getbootstrap.com/components/#glyphicons-glyphs" target="_blank"><span class="glyphicon glyphicon-question-sign glyphicon-helper"></span></a> #}
                        <select class="btn-xs" id="nlog_kind_icon">
                        {% include "includes/bootstrap_icons.html" %}
                        </select>
                        <a href="http://getbootstrap.com/components/#glyphicons-glyphs" target="_blank"><span class="glyphicon glyphicon-question-sign glyphicon-helper"></span></a>
                   </div>
                </div>
            </div>
            <div class="form-group">
                <label for="nlog_start_date">{% trans "When?" %}</label>
                <input type="text" class="form-control" id="nlog_start_date" placeholder="dd/mm/yyyy hh:mm">
            </div>
            <div class="checkbox">
                <label>
                <input class="has_enddate" type="checkbox"> {% trans "Has end date?" %}
                </label>
            </div>
            <div class="form-group end_date hidden">
                <label for="nlog_enddate">{% trans "When ended?" %}</label>
                <input type="text" class="form-control" id="nlog_enddate" placeholder="dd/mm/yyyy hh:mm">
            </div>
            <div class="form-group">
                <label for="nlog_body">{% trans "Description..." %}</label>
                <textarea class="form-control mention" rows="4" id="nlog_body"></textarea>
            </div>
            <div class="checkbox">
                <label>
                    <input type="checkbox" id="nlog_highlight"> {% trans "Highlight?" %}
                </label>
            </div>
            <br />
            <button type="submit" class="btn btn-warning">{% trans "Add log..." %}</button>
        </form>
    </div>
</div>
{% endblock %}

{% block js_footer %}
<script type="text/javascript">
vlogs = new Vue({
    el: '#vue_app',
    delimiters: ["[[", "]]"],
    data: {
        q: '',
        logs: ''
    },
    computed: {
        filteredLogs: function() {
            if (!this.logs) return 0;
            var self = this
            return this.logs.filter(function(log) {
                return (
                    (log.body.toLowerCase().indexOf(self.q.toLowerCase()) > -1) ||
                    (log.meta.toLowerCase().indexOf(self.q.toLowerCase()) > -1) ||
                    (log.start_date.toLowerCase().indexOf(self.q.toLowerCase()) > -1)
                )
            }.bind(this))
        }
    }
});
</script>
{% endblock %}
